# Лабораторная работа №4: Веб-приложение для расчета кадровых метрик
Карандашева Анастасия, 368273, группа P3332

### Цель работы
Реализовать веб-приложение на ClojureScript для расчета кадровых метрик: трудозатрат, численности персонала и рабочего времени. Приложение должно предоставлять интерфейс для ввода данных о должностях, работах и периодах, а также автоматически вычислять необходимые показатели.

### Основные требования

1. **Управление штатными должностями:**
   - Добавление, редактирование и удаление должностей
   - Хранение информации о должности: название, количество сотрудников, норма рабочего времени

2. **Описание работ:**
   - Создание записей о работах с привязкой к должностям
   - Указание времени выполнения операций (мин/макс) и их частоты
   - Расчет трудозатрат с учетом различных режимов: автоматический расчет, ручной ввод, полный период, пропорциональный расчет

3. **Рабочее время:**
   - Управление нормами рабочего времени по периодам (месяцы, кварталы, полугодия, год)
   - Учет дней отпуска для каждой должности
   - Автоматический расчет итоговой нормы времени с учетом отпусков

4. **Расчет численности:**
   - Вычисление целевой численности персонала на основе трудозатрат
   - Учет ненормируемых операций, времени на отдых и перерывы
   - Сравнение целевой и фактической численности
   - Расчет загруженности персонала

### Описание приложения

#### Архитектура

Приложение построено на основе архитектуры **re-frame** — функционального фреймворка для создания SPA на ClojureScript. Архитектура следует паттерну Model-View-Update (MVU):

- **Model (db.cljs):** Централизованное хранилище состояния приложения
- **Events (events.cljs):** Обработчики событий для изменения состояния
- **Subscriptions (subs.cljs):** Вычисляемые значения на основе состояния
- **Views (views/):** Компоненты пользовательского интерфейса

#### Технологический стек

**Сборка и инструменты:**
- `shadow-cljs` 2.26.2 — компилятор ClojureScript с поддержкой hot reload
- `npm` — менеджер пакетов для управления зависимостями
- `Node.js` — среда выполнения для инструментов сборки

**Библиотеки:**
- `re-frame` 1.4.2 — фреймворк для управления состоянием и UI
- `reagent` 1.1.1 — обертка над React для ClojureScript
- `react` 17.0.2 — библиотека для построения пользовательского интерфейса
- `devtools` 1.0.6 — инструменты разработчика для ClojureScript

**Структура проекта:**
```
my-app/
├── src/my_app/
│   ├── core.cljs              # Точка входа приложения
│   ├── db.cljs                # Начальное состояние БД
│   ├── events.cljs            # Обработчики событий
│   ├── subs.cljs              # Подписки на данные
│   ├── views.cljs             # Главный компонент
│   ├── calc/                  # Модули расчета
│   │   ├── calendar.cljs      # Работа с календарем и периодами
│   │   ├── workload.cljs      # Расчет трудозатрат
│   │   └── staff.cljs         # Расчет численности
│   ├── domain/
│   │   └── periods.cljs       # Определение периодов расчета
│   └── views/                 # Компоненты страниц
│       ├── common.cljs        # Общие компоненты
│       ├── home.cljs          # Главная страница
│       ├── positions.cljs     # Штатные должности
│       ├── workdescription.cljs # Описание работ
│       ├── worktime.cljs      # Рабочее время
│       └── staffing.cljs      # Расчет численности
├── resources/public/          # Статические ресурсы
│   └── index.html             # HTML шаблон
├── shadow-cljs.edn            # Конфигурация shadow-cljs
└── package.json               # Зависимости npm
```

#### Функциональность страниц

**1. Штатные должности (positions.cljs)**

Позволяет управлять списком должностей в организации:
- Добавление новых должностей
- Редактирование названия, количества сотрудников и нормы рабочего времени
- Удаление должностей

Данные хранятся в состоянии `:positions` как вектор карт с полями:
- `:id` — уникальный идентификатор
- `:name` — название должности
- `:count` — фактическое количество сотрудников
- `:norm` — норма рабочего времени в часах за год

**2. Описание работ (workdescription.cljs)**

Интерфейс для создания и редактирования описаний работ:
- Привязка работы к должности
- Указание бизнес-процесса и операции
- Ввод времени выполнения (мин/макс) в минутах или часах
- Автоматический расчет среднего времени по формуле: `(3*min + 2*max) / 5`
- Настройка частоты выполнения (день, неделя, месяц, квартал, полгода, год)
- Выбор режима расчета трудозатрат:
  - Автоматический расчет на основе частоты и времени
  - Ручной ввод трудозатрат
  - Полный период (учет всего периода)
  - Пропорциональный расчет

Расчет трудозатрат выполняется в модуле `calc.workload` с учетом:
- Преобразования единиц времени (минуты → часы)
- Множителей частоты для разных периодов
- Выбранного режима расчета

**3. Рабочее время (worktime.cljs)**

Управление нормами рабочего времени и отпусками:
- Отображение норм рабочего времени по месяцам (168, 160, 176 часов)
- Ввод количества дней отпуска для каждой должности и периода
- Автоматический расчет итоговой нормы: `норма - (дни_отпуска * 8)`
- Поддержка различных периодов: месяцы, кварталы, полугодия, год

Данные хранятся в `:worktime` как вложенная структура:
```clojure
{position-id {period-id {:vacation days}}}
```

**4. Расчет численности (staffing.cljs)**

Основная страница для расчета необходимой численности персонала:
- Выбор расчетного периода
- Ввод параметров для каждой должности:
  - Ненормируемые операции (часы в день)
  - Время на отдых и личные надобности (часы в день)
  - Неустранимые перерывы (часы в день)
- Автоматический расчет:
  - Процент потерь времени: `(ненорм + отдых + перерывы) / 8`
  - Эффективная норма: `норма * (1 - процент_потерь)`
  - Целевая численность: `трудозатраты / эффективная_норма`
  - Округленная целевая численность
  - Фактическая загруженность: `трудозатраты / (норма * фактическая_численность)`
  - Целевая загруженность: `целевая_численность / округленная_целевая`

### Ключевые элементы реализации

#### Модуль расчета трудозатрат (calc/workload.cljs)

```clojure
(defn workload [row position-norm selected-period]
  (let [{:keys [min-time max-time time-unit frequency frequency-param
                manual-hours full-period proportional-period]} row
        avg (avg-time min-time max-time)
        hours (to-hours avg time-unit)
        mult (frequency-multiplier frequency-param selected-period)
        base-calc (* hours frequency mult)]
    (cond
      proportional-period (if (number? manual-hours) manual-hours base-calc)
      full-period base-calc
      (number? manual-hours) manual-hours
      :else base-calc)))
```

Функция вычисляет трудозатраты с учетом различных режимов расчета и преобразует единицы измерения времени.

#### Модуль расчета численности (calc/staff.cljs)

```clojure
(defn effective-period-norm [raw-norm inputs]
  (let [loss (total-percent-loss inputs)]
    (* raw-norm (- 1 loss))))

(defn target-staff [work-hours effective-norm]
  (if (zero? effective-norm)
    0
    (/ work-hours effective-norm)))
```

Модуль содержит чистые функции для расчета эффективной нормы времени и целевой численности персонала.

#### Управление состоянием (events.cljs, subs.cljs)

Приложение использует паттерн re-frame для управления состоянием:

- **События (events):** Обработчики для изменения состояния через `reg-event-db`
- **Подписки (subs):** Вычисляемые значения через `reg-sub`, которые автоматически обновляются при изменении состояния
- **Реактивность:** Компоненты автоматически перерисовываются при изменении подписанных данных

Пример обработчика события:
```clojure
(rf/reg-event-db
 ::update-position
 (fn [db [_ id field value]]
   (update db :positions
           (fn [positions]
             (mapv (fn [p]
                     (if (= (:id p) id)
                       (assoc p field value)
                       p))
                   positions)))))
```

#### Компоненты пользовательского интерфейса

Компоненты построены на основе Reagent (обертка над React):
- Используют Hiccup-синтаксис для описания DOM
- Подписываются на данные через `@(rf/subscribe [:key])`
- Отправляют события через `rf/dispatch`
- Автоматически обновляются при изменении подписанных данных

Пример компонента:
```clojure
(defn position-row [{:keys [id name count norm]}]
  [:tr
   [:td
    [:input {:value name
             :on-change #(rf/dispatch
                          [::events/update-position id :name (.. % -target -value)])}]]
   ...])
```

### Особенности реализации

1. **Реактивность:** Использование подписок re-frame обеспечивает автоматическое обновление UI при изменении данных

2. **Модульность:** Логика расчета вынесена в отдельные модули (`calc/`), что упрощает тестирование и поддержку

3. **Разделение ответственности:** Представление (views), логика (events, subs), расчеты (calc)

4. **Hot reload:** Интеграция с shadow-cljs обеспечивает автоматическую перекомпиляцию и обновление приложения при изменении кода

5. **Работа с периодами:** Гибкая система периодов (месяцы, кварталы, полугодия, год) с автоматическим вычислением норм и агрегацией данных

### Взаимодействие между страницами

Данные между страницами связаны через общее состояние приложения:

- **Штатные должности** → используются в **Описании работ** для привязки работ
- **Описание работ** → вычисляет трудозатраты, используемые в **Расчете численности**
- **Рабочее время** → предоставляет нормы времени и отпуска для **Расчета численности**
- **Расчет численности** → агрегирует данные со всех страниц для финальных вычислений

Все связи реализованы через идентификаторы должностей (`:position-id`) и периоды расчета.

### Запуск приложения

1. Установить зависимости:
   ```bash
   npm install
   ```

2. Запустить сервер разработки:
   ```bash
   npx shadow-cljs watch app
   ```

3. Открыть в браузере: http://localhost:8280

Приложение автоматически перекомпилируется и обновляется в браузере при изменении исходного кода.

### Выводы

Очень приятная разработка веб-приложения на re-frame. Всё из коробки, сразу и база данных (общее место хранения состояния), и удобные инструменты сборки. В целом, больше всего понравилось именно выделение в отдельные .cljs файлы всей логики, связанной с обработкой событий, доступом и хранением данных. Удобно настраивать и отслеживать взаимосвязи между данными, используемыми на страницах.

В рамках функционального подхода постаралась вынести всю математическую логику в отдлельные файлы, засчет чего сами страницы получилось реализовать по одному и тому же принципу, просто с вызывом необходимых функций для вычислений и подпиской на данные.
